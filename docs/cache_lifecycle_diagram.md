# Диаграмма жизненного цикла кэша ролей

## 🔄 Жизненный цикл записи в кэше

```
┌─────────────────┐
│   Запрос роли   │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│  Есть в кэше?   │
└─────────┬───────┘
          │
    ┌─────┴─────┐
    │           │
    ▼           ▼
┌─────────┐ ┌─────────┐
│   ДА    │ │   НЕТ   │
└────┬────┘ └────┬────┘
     │           │
     ▼           ▼
┌─────────┐ ┌─────────┐
│ TTL OK? │ │ Запрос  │
└────┬────┘ │ к БД    │
     │      └────┬────┘
┌────┴────┐      │
│         │      │
▼         ▼      ▼
ДА       НЕТ ┌─────────┐
│         │  │ Сохран. │
▼         ▼  │ в кэш   │
┌─────────┐  └────┬────┘
│Возврат  │       │
│роли     │       │
└─────────┘       │
                  ▼
            ┌─────────┐
            │Возврат  │
            │роли     │
            └─────────┘
```

## ⏰ Временная диаграмма TTL

```
Время: 0min    1min    2min    3min    4min    5min    6min
      │       │       │       │       │       │       │
      ▼       ▼       ▼       ▼       ▼       ▼       ▼
Кэш:  [Создан] [Активен] [Активен] [Активен] [Активен] [Истек] [Удален]
      │       │       │       │       │       │       │
      ▼       ▼       ▼       ▼       ▼       ▼       ▼
БД:   [Запрос] [Кэш]   [Кэш]   [Кэш]   [Кэш]   [Запрос] [Кэш]
```

## 🔄 Сценарии обновления кэша

### 1. Автоматическое обновление при изменении роли

```
Пользователь: Изменение роли
      │
      ▼
┌─────────────┐
│ UsersRepo   │
│ .upsert()   │
└─────┬───────┘
      │
      ▼
┌─────────────┐
│ UPDATE БД   │
└─────┬───────┘
      │
      ▼
┌─────────────┐
│ Обновление  │
│ кэша        │
└─────────────┘
```

### 2. Фоновая очистка

```
Каждую минуту:
┌─────────────┐
│ Cleanup     │
│ Task        │
└─────┬───────┘
      │
      ▼
┌─────────────┐
│ Проверка    │
│ всех записей│
└─────┬───────┘
      │
      ▼
┌─────────────┐
│ Удаление    │
│ устаревших  │
└─────────────┘
```

## 📊 Статистика производительности

### Сценарий: 1000 активных пользователей

```
Без кэша:
┌─────────────┐
│ 1000 запросов│
│ к БД        │
│ ~5ms каждый │
│ = 5 секунд  │
└─────────────┘

С кэшем (80% попаданий):
┌─────────────┐
│ 800 попаданий│
│ ~0.01ms     │
│ = 8ms       │
└─────────────┘
┌─────────────┐
│ 200 промахов│
│ ~5ms каждый │
│ = 1 секунда │
└─────────────┘
Итого: ~1 секунда (ускорение в 5 раз)
```

## 🛡️ Защита от неактуальности

### Сценарий: Изменение роли в БД

```
Время: 0min    1min    2min    3min    4min    5min
      │       │       │       │       │       │
      ▼       ▼       ▼       ▼       ▼       ▼
БД:   [user]  [admin] [admin] [admin] [admin] [admin]
      │       │       │       │       │       │
      ▼       ▼       ▼       ▼       ▼       ▼
Кэш:  [user]  [user]  [user]  [user]  [user]  [admin]
      │       │       │       │       │       │
      ▼       ▼       ▼       ▼       ▼       ▼
TTL:  [OK]    [OK]    [OK]    [OK]    [OK]    [Истек]
```

**Максимальная неактуальность: 5 минут**

## 💾 Использование памяти

### Структура данных

```
Кэш: Dict[int, tuple[str, float]]
     │
     ├── user_id: int (8 байт)
     ├── role: str (~10 байт)
     └── timestamp: float (8 байт)
     
Итого: ~26 байт на пользователя
```

### Масштабирование

```
Пользователи │ Память │ Процент попаданий │ Ускорение
─────────────┼────────┼──────────────────┼──────────
100          │ 2.6 KB │ 95%              │ 20x
1,000        │ 26 KB  │ 90%              │ 10x
10,000       │ 260 KB │ 85%              │ 7x
100,000      │ 2.6 MB │ 80%              │ 5x
```

## 🚨 Алерты и мониторинг

### Критические метрики

```
┌─────────────────┐
│ /cache_stats    │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│ Процент попаданий│
│ < 60% = ПРОБЛЕМА│
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│ Размер кэша     │
│ > 10,000 = МНОГО│
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│ Частота обновл. │
│ > 100/мин = МНОГО│
└─────────────────┘
```

## 🎯 Заключение

Кэш ролей обеспечивает:

- ✅ **Высокую производительность** (ускорение в 5-20 раз)
- ✅ **Минимальную нагрузку** (~26 байт/пользователь)
- ✅ **Надежность** (максимум 5 минут неактуальности)
- ✅ **Масштабируемость** (поддержка 100,000+ пользователей)
- ✅ **Автоматическое управление** (TTL, очистка, обновление)
