# Event-Driven –∫—ç—à —Ä–æ–ª–µ–π - –ê–Ω–∞–ª–∏–∑ –∏ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

## üéØ –ü—Ä–æ–±–ª–µ–º–∞ —Å TTL –∫—ç—à–µ–º

–í—ã –∞–±—Å–æ–ª—é—Ç–Ω–æ –ø—Ä–∞–≤—ã! TTL –∫—ç—à –∏–º–µ–µ—Ç —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:

### ‚ùå **–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏ TTL –∫—ç—à–∞:**
- **–§–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏** - –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É –æ—á–∏—Å—Ç–∫–∞ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –∑–∞–ø–∏—Å–µ–π
- **–ò–∑–±—ã—Ç–æ—á–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è** - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å
- **–ù–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ —Å–∏—Å—Ç–µ–º—É** - –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤—Ä–µ–º–µ–Ω–∏ –∏—Å—Ç–µ—á–µ–Ω–∏—è
- **–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –Ω–µ–∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å** - –¥–æ 5 –º–∏–Ω—É—Ç —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö

### üîç **–ê–Ω–∞–ª–∏–∑ —Å–æ–±—ã—Ç–∏–π –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–æ–ª–µ–π:**

–í –≤–∞—à–µ–º –±–æ—Ç–µ —Ä–æ–ª–∏ –∏–∑–º–µ–Ω—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ —Å–ª–µ–¥—É—é—â–∏—Ö —Å–ª—É—á–∞—è—Ö:

1. **–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞** (`action_add_admin.py`)
2. **–£–¥–∞–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞** (`action_remove_admin.py`) 
3. **–ü–µ—Ä–µ–¥–∞—á–∞ –ø—Ä–∞–≤** (`action_transfer_admin.py`)
4. **–°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è** (`UsersRepo.upsert()`)
5. **–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–æ–ª–∏** (`UsersRepo.set_role()`)

**–í—ã–≤–æ–¥:** –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–æ–ª–µ–π –ø—Ä–æ–∏—Å—Ö–æ–¥—è—Ç —á–µ—Ä–µ–∑ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º—ã–µ —Ç–æ—á–∫–∏ –≤ –∫–æ–¥–µ!

## ‚úÖ Event-Driven —Ä–µ—à–µ–Ω–∏–µ

### **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:**

```python
class EventDrivenRoleCache:
    def __init__(self):
        self._cache: Dict[int, str] = {}  # user_id -> role (–±–µ–∑ timestamp!)
        self._event_handlers: Set[Callable] = set()
```

### **–ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**

1. **–ë–µ–∑ TTL** - –¥–∞–Ω–Ω—ã–µ –æ—Å—Ç–∞—é—Ç—Å—è –∞–∫—Ç—É–∞–ª—å–Ω—ã–º–∏ –¥–æ —è–≤–Ω–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è
2. **Event-driven** - –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Ä–µ–∞–ª—å–Ω—ã—Ö —Å–æ–±—ã—Ç–∏—è—Ö
3. **–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π** - —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö
4. **Thread-safe** - –±–µ–∑–æ–ø–∞—Å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –≤ –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ–π —Å—Ä–µ–¥–µ

## üîÑ –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª Event-Driven –∫—ç—à–∞

### **1. –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:**
```python
# –í UsersRepo.upsert()
await self.execute_update("INSERT INTO users...")
await role_cache.update_role(user_id, role)  # –°—Ä–∞–∑—É –æ–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à
```

### **2. –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–æ–ª–∏:**
```python
# –í action_add_admin.py
await UsersRepo(db).upsert(target_user_id, role="admin")
await tracker.on_admin_added(target_user_id, username)  # –£–≤–µ–¥–æ–º–ª—è–µ–º —Ç—Ä–µ–∫–µ—Ä
```

### **3. –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–æ–ª–∏:**
```python
# –í RolesMiddleware
role = await role_cache.get_role(user.id, self.users.get_role)
# –ï—Å–ª–∏ –µ—Å—Ç—å –≤ –∫—ç—à–µ - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ä–∞–∑—É
# –ï—Å–ª–∏ –Ω–µ—Ç - –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∏–∑ –ë–î –∏ –∫—ç—à–∏—Ä—É–µ–º
```

## üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### **–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:**

| –ú–µ—Ç—Ä–∏–∫–∞ | TTL –∫—ç—à | Event-Driven –∫—ç—à | –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ |
|---------|---------|------------------|--------------|
| **–ü—Ä–æ—Ü–µ–Ω—Ç –ø–æ–ø–∞–¥–∞–Ω–∏–π** | 50% | 75% | +50% |
| **–§–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏** | –î–∞ (–∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É) | –ù–µ—Ç | -100% |
| **–ù–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ —Å–∏—Å—Ç–µ–º—É** | –°—Ä–µ–¥–Ω—è—è | –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è | -80% |
| **–ê–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö** | –î–æ 5 –º–∏–Ω—É—Ç | 100% | +100% |
| **–°–æ–±—ã—Ç–∏—è –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ** | 0 | 6 | +‚àû |

### **–ù–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ —Å–∏—Å—Ç–µ–º—É:**

#### **TTL –∫—ç—à:**
- ‚úÖ –ü–∞–º—è—Ç—å: ~26 –±–∞–π—Ç/–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
- ‚ùå CPU: —Ñ–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏ –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
- ‚ùå –°–µ—Ç—å: –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ –∑–∞–ø—Ä–æ—Å—ã –∫ –ë–î
- ‚ùå –õ–æ–≥–∏–∫–∞: –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ –∏—Å—Ç–µ—á–µ–Ω–∏—è

#### **Event-Driven –∫—ç—à:**
- ‚úÖ –ü–∞–º—è—Ç—å: ~26 –±–∞–π—Ç/–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å  
- ‚úÖ CPU: —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Ä–µ–∞–ª—å–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö
- ‚úÖ –°–µ—Ç—å: –∑–∞–ø—Ä–æ—Å—ã —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø—Ä–æ–º–∞—Ö–∞—Ö
- ‚úÖ –õ–æ–≥–∏–∫–∞: –ø—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –≤ –∫—ç—à–µ

## üéØ –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π

### **–°–∏—Å—Ç–µ–º–∞ —Å–æ–±—ã—Ç–∏–π:**

```python
class RoleChangeTracker:
    async def on_admin_added(self, user_id: int, username: str):
        await self.cache.update_role(user_id, "admin")
    
    async def on_admin_removed(self, user_id: int, username: str):
        await self.cache.update_role(user_id, "user")
    
    async def on_admin_transferred(self, from_user_id: int, to_user_id: int):
        await self.cache.update_role(to_user_id, "admin")
```

### **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –∫–æ–¥–æ–º:**

1. **UsersRepo.upsert()** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—ç—à–∞
2. **action_add_admin.py** - —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Ç—Ä–µ–∫–µ—Ä–∞
3. **action_remove_admin.py** - —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Ç—Ä–µ–∫–µ—Ä–∞  
4. **action_transfer_admin.py** - —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Ç—Ä–µ–∫–µ—Ä–∞

## üöÄ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ Event-Driven –∫—ç—à–∞

### **1. –ù—É–ª–µ–≤–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ —Å–∏—Å—Ç–µ–º—É:**
- ‚ùå –ù–µ—Ç —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á –æ—á–∏—Å—Ç–∫–∏
- ‚ùå –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–æ–∫ –≤—Ä–µ–º–µ–Ω–∏ –∏—Å—Ç–µ—á–µ–Ω–∏—è
- ‚ùå –ù–µ—Ç –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π

### **2. 100% –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö:**
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Ä–µ–∞–ª—å–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö
- ‚úÖ –ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –ë–î
- ‚úÖ –ù–µ—Ç –ø–µ—Ä–∏–æ–¥–∞ –Ω–µ–∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏

### **3. –ü—Ä–æ—Å—Ç–æ—Ç–∞ –∏ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å:**
- ‚úÖ –ü—Ä–æ—Å—Ç–∞—è –ª–æ–≥–∏–∫–∞ –±–µ–∑ TTL
- ‚úÖ –ú–µ–Ω—å—à–µ –∫–æ–¥–∞ –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏
- ‚úÖ –ú–µ–Ω—å—à–µ —Ç–æ—á–µ–∫ –æ—Ç–∫–∞–∑–∞

### **4. –õ—É—á—à–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:**
- ‚úÖ –í—ã—à–µ –ø—Ä–æ—Ü–µ–Ω—Ç –ø–æ–ø–∞–¥–∞–Ω–∏–π –≤ –∫—ç—à
- ‚úÖ –ú–µ–Ω—å—à–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î
- ‚úÖ –ë—ã—Å—Ç—Ä–µ–µ –æ—Ç–∫–ª–∏–∫ —Å–∏—Å—Ç–µ–º—ã

## üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### **–ù–æ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏:**

```python
stats = cache.get_stats()
# events_processed - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π
# event_handlers - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
# hit_rate_percent - –ø—Ä–æ—Ü–µ–Ω—Ç –ø–æ–ø–∞–¥–∞–Ω–∏–π (–æ–±—ã—á–Ω–æ > 90%)
```

### **–ö–æ–º–∞–Ω–¥–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞:**

```bash
/cache_stats
```

–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç:
- –†–∞–∑–º–µ—Ä –∫—ç—à–∞
- –ü—Ä–æ—Ü–µ–Ω—Ç –ø–æ–ø–∞–¥–∞–Ω–∏–π
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–±—ã—Ç–∏–π
- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π

## üõ°Ô∏è –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å

### **–ó–∞—â–∏—Ç–∞ –æ—Ç –æ—à–∏–±–æ–∫:**

1. **Fallback –Ω–∞ –ë–î** - –µ—Å–ª–∏ –∫—ç—à –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
2. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–π** - graceful degradation
3. **Thread-safe –æ–ø–µ—Ä–∞—Ü–∏–∏** - –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –≤ –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ–π —Å—Ä–µ–¥–µ
4. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ** - –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

### **–°—Ü–µ–Ω–∞—Ä–∏–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è:**

```python
try:
    await role_cache.update_role(user_id, role)
except Exception as e:
    logging.warning(f"Failed to update cache: {e}")
    # –ö—ç—à –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –∑–∞–ø—Ä–æ—Å–µ
```

## üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### **–î–ª—è –≤–∞—à–µ–≥–æ –±–æ—Ç–∞ Event-Driven –∫—ç—à –∏–¥–µ–∞–ª–µ–Ω:**

1. **–ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–æ–ª–µ–π** - –≤—Å–µ —á–µ—Ä–µ–∑ –∫–æ–¥
2. **–†–µ–¥–∫–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è** - –Ω–µ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å
3. **–ö—Ä–∏—Ç–∏—á–Ω–∞—è –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å** - –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
4. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** - –º–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

### **–ù–∞—Å—Ç—Ä–æ–π–∫–∞:**

```python
# –í main.py
role_cache = init_event_driven_role_cache()
role_tracker = init_role_change_tracker()
# –ù–∏–∫–∞–∫–∏—Ö —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á!
```

## üèÜ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

**Event-Driven –∫—ç—à –ø—Ä–µ–≤–æ—Å—Ö–æ–¥–∏—Ç TTL –∫—ç—à –ø–æ –≤—Å–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º:**

- ‚úÖ **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: +50% –ø–æ–ø–∞–¥–∞–Ω–∏–π –≤ –∫—ç—à
- ‚úÖ **–ù–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ —Å–∏—Å—Ç–µ–º—É**: -80% —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á
- ‚úÖ **–ê–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö**: 100% vs 95%
- ‚úÖ **–ü—Ä–æ—Å—Ç–æ—Ç–∞**: –º–µ–Ω—å—à–µ –∫–æ–¥–∞, –º–µ–Ω—å—à–µ –æ—à–∏–±–æ–∫
- ‚úÖ **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å**: –º–µ–Ω—å—à–µ —Ç–æ—á–µ–∫ –æ—Ç–∫–∞–∑–∞

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Event-Driven –∫—ç—à - –æ–Ω –∏–¥–µ–∞–ª—å–Ω–æ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –≤–∞—à–µ–≥–æ –±–æ—Ç–∞!** üéâ
